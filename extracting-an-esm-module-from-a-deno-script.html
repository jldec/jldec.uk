<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">

<meta property="og:title" content="Extracting an ESM module from a Deno script">
<meta property="og:image" content="https://jldec.me/images/persewide.jpg">
<meta property="og:type" content="article">
<meta property="og:url" content="https://jldec.me/extracting-an-esm-module-from-a-deno-script">
<meta property="og:description" content="Will the NPM ecosystem evolve to support nested ESM modules?">
<meta name="twitter:site" content="@jldec">
<meta name="twitter:creator" content="@jldec">
<meta name="twitter:title" content="Extracting an ESM module from a Deno script">
<meta name="twitter:description" content="Will the NPM ecosystem evolve to support nested ESM modules?">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:widgets:new-embed-design" content="on">
<meta name="twitter:image" content="https://jldec.me/images/persewide.jpg">
<meta name="twitter:image:alt" content="Sunny day in Cambridge UK">
<meta name="robots" content="noindex, nofollow">
<link rel="canonical" href="https://jldec.me/extracting-an-esm-module-from-a-deno-script">

<!-- html generated by pub-server from markdown /extracting-an-esm-module-from-a-deno-script.md -->

<title>Extracting an ESM module from a Deno script</title>
<link rel="stylesheet" href="./css/pubblog.css">
<link rel="stylesheet" href="./css/open-sans.css">
<link rel="stylesheet" href="./css/font-awesome.css">
<link rel="stylesheet" href="./css/highlight-9.18.1-github.css">
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>

<div data-render-layout="main-layout">
<header>
<div id="doctitle"><h1 id="jldecuk"><a href="./">jldec.uk</a></h1>
</div>
<div id="topmenu"><div data-render-html="/#topmenu">&nbsp;</div></div>
</header>

<div id="navicon" onclick=""><p><span class="fa fa-fw fa-2x">&#xf01a;</span></p>

<nav id="toc">
<ul>
<li><strong><a href="./">Home</a></strong></li>
<li><a href="./getting-started-with-go">Getting started with Go</a></li>
<li><a href="./extracting-an-esm-module-from-a-deno-script">Extracting an ESM module from a Deno script</a></li>
<li><a href="./running-a-compiled-deno-script-in-a-github-action">Running a compiled Deno script in a GitHub Action</a></li>
<li><a href="./getting-started-with-deno">Getting Started with Deno</a></li>
<li><a href="./calling-rust-from-a-cloudflare-worker">Calling Rust from a Cloudflare Worker</a></li>
<li><a href="./fun-with-vercel">Fun with Vercel</a></li>
<li><a href="./first-steps-using-cloudflare-pages">First steps using Cloudflare Pages</a></li>
<li><a href="./migrating-from-cjs-to-esm">Migrating from CommonJS to ESM</a></li>
<li><a href="./forays-from-node-to-rust">Forays from Node to Rust</a></li>
<li><a href="./github-actions-101">GitHub Actions 101</a></li>
<li><a href="./a-web-for-everyone">A Web for Everyone</a></li>
<li><a href="./why-serverless-at-the-edge">Why Serverless at the Edge?</a></li>
<li><a href="./spring-boot-101">Spring Boot 101</a></li>
<li><a href="./why-the-web-needs-better-html-editing-components">Why the Web needs better HTML editing components</a></li>
<li><a href="./about">About me</a></li>
</ul>
</nav>
</div>

<div id="title" style='background-image:url("images/persewide.jpg");'>
  <div class="title">Extracting an ESM module from a Deno script</div>
  <div class="subtitle"></div>
</div>

<div id="main" onclick="">
<div id="content">

<div data-render-page="/extracting-an-esm-module-from-a-deno-script">
<span class="permalink"><a class="permalink" href="./extracting-an-esm-module-from-a-deno-script" title="Link to this post.">&#xf0c1;</a></span><span class="date">2021-03-21</span>

<div >
<div data-render-html="/extracting-an-esm-module-from-a-deno-script"><p>This is another followup to my recent post about <a href="./getting-started-with-deno">Getting Started with Deno</a>.</p>
<p>I thought it would make sense to extract the crawler code into its own <a href="./migrating-from-cjs-to-esm">ESM module</a> so that it can also be used with Node.js or in the browser.</p>
<p>The resulting <a href="https://github.com/jldec/deno-hello/blob/main/scanurl.mjs#L18" target="_blank" rel="noopener">API</a> is a bit ugly because it expects parse5 and fetch as parameters, but it works  .</p>
<pre><code class="language-js">/**
 * @param {URL} rootURL
 * @param {boolean} noRecurse
 * @param {boolean} quiet
 * @param {function} parse5 - transitive dependency
 * @param {function} fetch - native or npm package
 * @param {Object} fetchOpts options passed to fetch - optional
 * @returns {Object} map of url -&gt; { url, status, in, [error] }
 */
export default async function scanurl(rootURL, noRecurse, quiet, parse5, fetch, fetchOpts) {
</code></pre>
<h2 id="calling-the-esm-module-from-the-browser">Calling the ESM module from the browser</h2>
<p>You can try running the module from inside your own browser at <a href="https://deno-hello.jldec.me/" target="_blank" rel="noopener">https://deno-hello.jldec.me/</a>.</p>
<p><a href="https://deno-hello.jldec.me/" target="_blank" rel="noopener"><img src="./images/deno-hello.jldec.me.png" alt="Screenshot of https://deno-hello.jldec.me"></a></p>
<p>The page shows how to import the module from an inline <code>&lt;script type=&quot;module&quot;&gt;</code>.</p>
<pre><code class="language-html">&lt;script type=&quot;module&quot; id=&quot;code&quot;&gt;
import scanurl from &#39;./scanurl.mjs&#39;;
import parse5 from &#39;https://cdn.skypack.dev/parse5&#39;;
...
&lt;/script&gt;
</code></pre>
<p>Note that the usual browser CORS restrictions also apply to ESM modules, and to fetch() calls. In this case &#39;scanurl&#39; is imported using a relative path on the same origin, and &#39;parse5&#39; is imported using <a href="https://www.skypack.dev/" target="_blank" rel="noopener">https://www.skypack.dev/</a>.</p>
<h2 id="using-the-scanode-esm-module-with-node">Using the scanode ESM module with Node</h2>
<p>I have published <a href="https://www.npmjs.com/package/scanode" target="_blank" rel="noopener">scanode</a> as a package on npm. If you have Node, you can run it with &#39;npx&#39; or install it using &#39;npm install&#39;.</p>
<pre><code>$ npx scanode https://jldec.me
npx: installed 3 in 0.987s
parsing /
...
14 pages scanned.
ðŸŽ‰ no broken links found.
</code></pre>
<p>You can also call the module API from your own code as in <a href="https://github.com/jldec/deno-hello/blob/main/node_example/test-scan.js" target="_blank" rel="noopener">node_example/test-scan.js</a>.</p>
<pre><code class="language-js">import fetch from &#39;node-fetch&#39;;
import parse5 from &#39;parse5&#39;;
import scanode from &#39;scanode&#39;;

const result = await scanode(
  new URL(&#39;https://jldec.me&#39;),
  false, // noRecurse
  false, // quiet
  parse5,
  fetch
);
</code></pre>
<p>Notice the imports for &#39;parse5&#39; and &#39;node-fetch&#39;. These are included as dependencies in the <a href="https://github.com/jldec/deno-hello/blob/main/package.json#L9" target="_blank" rel="noopener">package.json</a> for scanode.</p>
<pre><code class="language-json">{
  &quot;name&quot;: &quot;scanode&quot;,
  &quot;version&quot;: &quot;2.0.1&quot;,
  &quot;description&quot;: &quot;ESM module - crawls a website, validating that all the links on the site which point to the same orgin can be fetched.&quot;,
  &quot;main&quot;: &quot;scanurl.mjs&quot;,
  &quot;bin&quot;: {
    &quot;scanode&quot;: &quot;./bin/scanode.mjs&quot;
  },
  &quot;dependencies&quot;: {
    &quot;node-fetch&quot;: &quot;^2.6.1&quot;,
    &quot;parse5&quot;: &quot;^6.0.1&quot;
  }
  ...
</code></pre>
<h2 id="so-whats-wrong-with-this-picture">So what&#39;s wrong with this picture?</h2>
<p>As discussed <a href="./migrating-from-cjs-to-esm">before</a>, the NPM ecosystem predates ESM modules, so the two worlds don&#39;t play very nicely together. Node.js programs cannot easily load ESM modules which are not in NPM. Meanwhile, browsers know nothing about package.json or the node_modules directory.</p>
<p>When ESM modules depend on other modules, they use &#39;import&#39; statements with a URL or relative path. Node.js expects those sub-modules to be referenced by their NPM package names.</p>
<p>The result is that modules which depend on other modules are not portable between the two worlds, without an additional transformation step, or maybe an <a href="https://caniuse.com/import-maps" target="_blank" rel="noopener">import map</a>.</p>
<p>And this is why, for now, the API above expects the <code>parse5</code> module dependency as a parameter.</p>
<blockquote>
<p>The big question is whether the NPM ecosystem will evolve to support nested ESM modules, or whether some other organization with a workable trust model will emerge to replace it.</p>
</blockquote>
<p>Where there&#39;s a problem, there&#39;s an opportunity!</p>
<h1 id="ðŸš€">ðŸš€</h1>
<p><em>To leave a comment<br>please visit <a href="https://dev.to/jldec/extracting-an-esm-module-from-a-deno-script-28il" target="_blank" rel="noopener">dev.to/jldec</a></em></p>
</div>
</div>


</div><!--page-->

<div id="credit"><p><span class="fa">&#xf004;</span> powered by <a href="https://jldec.github.io/pub-doc/" target="_blank" rel="noopener">pub-server</a> and <a href="https://github.com/jldec/pub-theme-pubblog" target="_blank" rel="noopener">pub-theme-pubblog</a></p>
</div>

</div>
</div>

</div><!--layout-->

<script>window.pubRef = {"href":"/extracting-an-esm-module-from-a-deno-script","relPath":"."};</script>
<script src="./js/jquery-1.12.4.min.js" ></script>
<script src="./js/highlight-9.18.1.min.js" ></script>
<script src="./js/pub-pkg-highlight.js" ></script>
<script src="./pub/pub-ux.js" ></script>
<!-- copyright -->
</body>
</html>

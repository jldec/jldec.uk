<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="robots" content="noindex, nofollow">

<!-- html generated by pub-server from markdown /forays-from-node-to-rust.md -->

<title>Forays from Node to Rust</title>
<link rel="stylesheet" href="./css/pubblog.css">
<link rel="stylesheet" href="./css/open-sans.css">
<link rel="stylesheet" href="./css/font-awesome.css">
<link rel="stylesheet" href="./css/highlight-9.18.1-github.css">
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>

<div data-render-layout="main-layout">
<header>
<div id="doctitle"><h1 id="jldecuk"><a href="./">jldec.uk</a></h1>
</div>
<div id="topmenu"><div data-render-html="/#topmenu">&nbsp;</div></div>
</header>

<div id="navicon" onclick=""><p><span class="fa fa-fw fa-2x">&#xf01a;</span></p>

<nav id="toc">
<ul>
<li><strong><a href="./">Home</a></strong></li>
<li><a href="./calling-rust-from-a-cloudflare-worker">Calling Rust from a Cloudflare Worker</a></li>
<li><a href="./fun-with-vercel">Fun with Vercel</a></li>
<li><a href="./first-steps-using-cloudflare-pages">First steps using Cloudflare Pages</a></li>
<li><a href="./migrating-from-cjs-to-esm">Migrating from CommonJS to ESM</a></li>
<li><a href="./forays-from-node-to-rust">Forays from Node to Rust</a></li>
<li><a href="./github-actions-101">GitHub Actions 101</a></li>
<li><a href="./a-web-for-everyone">A Web for Everyone</a></li>
<li><a href="./why-serverless-at-the-edge">Why Serverless at the Edge?</a></li>
<li><a href="./spring-boot-101">Spring Boot 101</a></li>
<li><a href="./why-the-web-needs-better-html-editing-components">Why the Web needs better HTML editing components</a></li>
<li><a href="./about">About me</a></li>
</ul>
</nav>
</div>

<div id="title" style='background-image:url("images/fog.jpg");'>
  <div class="title">Forays from Node to Rust</div>
  <div class="subtitle"></div>
</div>

<div id="main" onclick="">
<div id="content">

<div data-render-page="/forays-from-node-to-rust">
<span class="permalink"><a class="permalink" href="./forays-from-node-to-rust" title="Link to this post.">&#xf0c1;</a></span><span class="date">2021-01-10</span>

<div >
<div data-render-html="/forays-from-node-to-rust"><h2 id="why-rust">Why Rust?</h2>
<p>A couple of years ago I picked up the excellent <a href="https://www.oreilly.com/library/view/programming-rust/9781491927274/" target="_blank" rel="noopener">Programming Rust</a> book.</p>
<p>Reading how the Rust compiler enforces memory safety and avoids data-races reminded me of the AHA! moment, when I learned how <a href="https://nodejs.org/en/about/" target="_blank" rel="noopener">Node.js</a> makes concurrency accessible to JavaScript developers, without the synchronization headaches of multi-threaded servers.</p>
<p>But there&#39;s more. Rust programs have a very minimal runtime - no garbage collector or class loader. This makes Rust ideal for constrained environments like embedded systems or edge compute platforms - so watch <a href="https://github.com/oxidecomputer" target="_blank" rel="noopener">this</a> <a href="https://github.com/bytecodealliance" target="_blank" rel="noopener">space</a>.</p>
<h2 id="first-impressions">First impressions</h2>
<p>This article covers the experience of buiding my first Rust crate.</p>
<p>The <a href="https://github.com/jldec/shortscale-rs" target="_blank" rel="noopener">shortscale-rs</a> library tries to replicate <a href="https://github.com/jldec/shortscale" target="_blank" rel="noopener">shortscale</a>, a small JavaScript module with just one function which converts numbers to English words.</p>
<p>The <a href="https://www.rust-lang.org" target="_blank" rel="noopener">Rust ecosystem</a> has produced an absolutely awesome array of tools and documentation.</p>
<p>To get started:</p>
<ul>
<li>Install Rust <a href="https://www.rust-lang.org/tools/install" target="_blank" rel="noopener">using rustup</a>.</li>
<li>Run &#39;rustup update&#39; whenever there is a new <a href="https://github.com/rust-lang/rust/releases" target="_blank" rel="noopener">Rust release</a>.</li>
</ul>
<p>Those steps also take care of &#39;cargo&#39;, the Rust build tool.</p>
<p><img src="./images/cargo.png" alt="Image showing cargo commands"><br><em><a href="https://www.rust-lang.org/learn/get-started" target="_blank" rel="noopener">https://www.rust-lang.org/learn/get-started</a></em></p>
<h2 id="vs-code">VS Code</h2>
<p>I followed the <a href="https://jason-williams.co.uk/debugging-rust-in-vscode" target="_blank" rel="noopener">recommendations</a> of Jason Williams to install <a href="https://marketplace.visualstudio.com/items?itemName=matklad.rust-analyzer" target="_blank" rel="noopener">Rust Analyzer</a> for VS Code instead of the default Rust extension. You&#39;ll also need <a href="https://marketplace.visualstudio.com/items?itemName=vadimcn.vscode-lldb" target="_blank" rel="noopener">CodeLLDB</a> for debugging.</p>
<p><img src="./images/vs-code-rust.png" alt="VS Code showing Rust program"><br>I particularly like the ability to run doctests directly in the VS Code terminal.</p>
<h2 id="rust-string-and-str">Rust String and str</h2>
<p>In <strong>JavaScript</strong> building strings is straightforward. Simply use <code>+</code> to concatenate any string to any other string. Empty strings being <a href="https://developer.mozilla.org/en-US/docs/Glossary/Falsy" target="_blank" rel="noopener">falsy</a> helps to write very compact logic.</p>
<p>The example below from <a href="https://github.com/jldec/shortscale/blob/main/shortscale.js#L96" target="_blank" rel="noopener">shortscale.js</a> behaves like the built-in <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/join" target="_blank" rel="noopener">Array.join</a>, except that it avoids repeating separators by ignoring empty strings.</p>
<pre><code class="language-js">// concatenate array of strings, separated by sep, ignoring &#39;&#39; values
function concat(strings, sep) {
  return strings.reduce((s1, s2) =&gt; s1 + (s1 &amp;&amp; s2 ? sep : &#39;&#39;) + s2, &#39;&#39;)
}
</code></pre>
<p>Here&#39;s my <a href="https://github.com/jldec/shortscale-rs/blob/main/src/extra.rs#L374" target="_blank" rel="noopener">first attempt</a> to do something similar in <strong>Rust</strong>.</p>
<pre><code class="language-rust">type Strvec = Vec&lt;&amp;&#39;static str&gt;;

// concatenate 2 Strvec&#39;s, separated with &quot;and&quot; if both have length
fn concat_and(v1: Strvec, v2: Strvec) -&gt; Strvec {
    match (v1.len(), v2.len()) {
        (_, 0) =&gt; v1,
        (0, _) =&gt; v2,
        (_, _) =&gt; [v1, vec![&quot;and&quot;], v2].concat(),
    }
}
</code></pre>
<p>&#39;Why Strvec?&#39;, you might ask. In Rust, the primitive string type, used for string literals, is a <a href="https://doc.rust-lang.org/nightly/std/primitive.str.html" target="_blank" rel="noopener">str</a>. My first thought was that shortscale-rs should manipulate collections of str&#39;s. So, instead of using <a href="https://doc.rust-lang.org/nightly/std/string/struct.String.html" target="_blank" rel="noopener">String</a> concatenation, I put str&#39;s into <a href="https://doc.rust-lang.org/nightly/std/vec/struct.Vec.html" target="_blank" rel="noopener">Vec</a>&#39;s.</p>
<p>Notice the elegant <a href="https://doc.rust-lang.org/rust-by-example/flow_control/match.html" target="_blank" rel="noopener">match</a> syntax - one of my favorite Rust language features. The compiler ensures that the &#39;arms&#39; of the match cover all possible inputs. The result is both readable and concise. The &#39;_&#39; is shorthand for any value.</p>
<blockquote>
<p>Performance does not matter,<br>until it absolutely does.<br><a href="https://twitter.com/matteocollina/status/1260887018617352192?s=20" target="_blank" rel="noopener">@matteocollina</a></p>
</blockquote>
<h2 id="benchmarks">Benchmarks</h2>
<p>The measured <a href="https://github.com/jldec/shortscale-rs#extra" target="_blank" rel="noopener">performance</a> was, well, an eye-opener! ~4459ns per <a href="https://docs.rs/shortscale/1.3.2/src/shortscale/extra.rs.html#314-336" target="_blank" rel="noopener">shortscale_vec_concat</a> call in Rust, compared to ~1342ns for the equivalent in Node.js.</p>
<p><a href="https://github.com/jldec/shortscale-rs/blob/main/benches/bench-shortscale.rs" target="_blank" rel="noopener">cargo bench</a></p>
<pre><code>shortscale                          251 ns/iter (+/- 18)
shortscale_string_writer_no_alloc   191 ns/iter (+/- 11)
shortscale_str_push                 247 ns/iter (+/- 22)
shortscale_vec_push                 363 ns/iter (+/- 26)
shortscale_display_no_alloc         498 ns/iter (+/- 21)
shortscale_vec_concat              4459 ns/iter (+/- 344)
shortscale_string_join             5549 ns/iter (+/- 378)
</code></pre>
<p><a href="https://github.com/jldec/shortscale/blob/main/test/bench.js" target="_blank" rel="noopener">npm run bench</a></p>
<pre><code>shortscale                         1342 ns/iter
</code></pre>
<p>Clearly the v8 JavaScript engine in Node.js is working very hard to make string manipulation efficient.</p>
<h2 id="learn--iterate">Learn &amp; Iterate</h2>
<p>The next thing I tried was to replace the Vec collections with simple Strings, creating and returning those from each function in the Rust program. This is <a href="https://docs.rs/shortscale/1.3.2/src/shortscale/extra.rs.html#389-406" target="_blank" rel="noopener">shortscale_string_join</a>. You should see from the benchmark, that its performance was <em>even worse</em>. Clearly I was doing something wrong.</p>
<p>Fast forward to the <a href="https://docs.rs/shortscale/1.3.2/src/shortscale/shortscale.rs.html#46-61" target="_blank" rel="noopener">current implementation</a>, which mutates a pre-allocated String rather than calling functions which create and return new Strings.</p>
<blockquote>
<p>The result is significantly faster than JavaScript.</p>
</blockquote>
<p>I still have a lot to learn, but this exercise was a great way to start building an intuition for Rust development and the performance of Rust primitives.</p>
<blockquote>
<p><span class="fa fa-3x">&#xf085;</span></p>
</blockquote>
<p><em>To leave a comment<br>please visit <a href="https://dev.to/jldec/forays-from-node-to-rust-3fk1" target="_blank" rel="noopener">dev.to/jldec</a></em></p>
</div>
</div>


</div><!--page-->

<div id="credit"><p><span class="fa">&#xf004;</span> powered by <a href="https://jldec.github.io/pub-doc/" target="_blank" rel="noopener">pub-server</a> and <a href="https://github.com/jldec/pub-theme-pubblog" target="_blank" rel="noopener">pub-theme-pubblog</a></p>
</div>

</div>
</div>

</div><!--layout-->

<script>window.pubRef = {"href":"/forays-from-node-to-rust","relPath":"."};</script>
<script src="./js/jquery-1.12.4.min.js" ></script>
<script src="./js/highlight-9.18.1.min.js" ></script>
<script src="./js/pub-pkg-highlight.js" ></script>
<script src="./pub/pub-ux.js" ></script>
<!-- copyright -->
</body>
</html>

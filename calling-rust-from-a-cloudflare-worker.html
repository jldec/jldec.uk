<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">

<meta name="robots" content="noindex, nofollow">
<link rel="canonical" href="https://jldec.me/calling-rust-from-a-cloudflare-worker">

<!-- html generated by pub-server from markdown /calling-rust-from-a-cloudflare-worker.md -->

<title>Calling Rust from a Cloudflare Worker</title>
<link rel="stylesheet" href="./css/pubblog.css">
<link rel="stylesheet" href="./css/open-sans.css">
<link rel="stylesheet" href="./css/font-awesome.css">
<link rel="stylesheet" href="./css/prism.css">
</head>
<body>

<div data-render-layout="main-layout">
<header>
<div id="doctitle"><h1 id="jldecuk"><a href="./">jldec.uk</a></h1>
</div>
<div id="topmenu"><div data-render-html="/#topmenu">&nbsp;</div></div>
</header>

<div id="navicon" onclick=""><p><span class="fa fa-fw fa-2x">&#xf01a;</span></p>

<nav id="toc">
<ul>
<li><strong><a href="./">Home</a></strong></li>
<li><a href="./getting-started-with-python-packaging">Getting started with Python Packaging</a></li>
<li><a href="./lets-figure-out-whats-next-together">News</a></li>
<li><a href="./about">About me</a></li>
<li><a href="./what-is-git-lfs">What is git LFS?</a></li>
<li><a href="./first-impressions-of-the-new-github-projects-beta">First impressions of the new GitHub Projects Beta</a></li>
<li><a href="./using-gitpod-to-create-a-pr">Using Gitpod to create a PR</a></li>
<li><a href="./preventing-concurrent-github-actions">Preventing concurrent GitHub Actions</a></li>
<li><a href="./getting-started-with-go-part-3-goroutines-and-channels">Getting started with Goroutines and channels</a></li>
<li><a href="./getting-started-with-go-part-2-pointers">Getting started with Go pointers</a></li>
<li><a href="./getting-started-with-go">Getting started with Go</a></li>
<li><a href="./extracting-an-esm-module-from-a-deno-script">Extracting an ESM module from a Deno script</a></li>
<li><a href="./running-a-compiled-deno-script-in-a-github-action">Running a compiled Deno script in a GitHub Action</a></li>
<li><a href="./getting-started-with-deno">Getting Started with Deno</a></li>
<li><a href="./calling-rust-from-a-cloudflare-worker">Calling Rust from a Cloudflare Worker</a></li>
<li><a href="./fun-with-vercel">Fun with Vercel</a></li>
<li><a href="./first-steps-using-cloudflare-pages">First steps using Cloudflare Pages</a></li>
<li><a href="./migrating-from-cjs-to-esm">Migrating from CommonJS to ESM</a></li>
<li><a href="./forays-from-node-to-rust">Forays from Node to Rust</a></li>
<li><a href="./github-actions-101">GitHub Actions 101</a></li>
<li><a href="./a-web-for-everyone">A Web for Everyone</a></li>
<li><a href="./why-serverless-at-the-edge">Why Serverless at the Edge?</a></li>
<li><a href="./spring-boot-101">Spring Boot 101</a></li>
<li><a href="./why-the-web-needs-better-html-editing-components">Why the Web needs better HTML editing components</a></li>
</ul>
</nav>
</div>

<div id="title" style='background-image:url("./images/moonbird.jpg");'>
  <div class="title">Calling Rust from a Cloudflare Worker</div>
  <div class="subtitle"></div>
</div>

<div id="main" onclick="">
<div id="content">

<div data-render-page="/calling-rust-from-a-cloudflare-worker">
<span class="permalink"><a class="permalink" href="./calling-rust-from-a-cloudflare-worker" title="Link to this post.">&#xf0c1;</a></span><span class="date">2021-02-14</span>

<div >
<div data-render-html="/calling-rust-from-a-cloudflare-worker"><h2 id="webassembly-and-rust">WebAssembly and Rust</h2>
<p>From the <a href="https://webassembly.github.io/spec/core/intro/introduction.html" target="_blank" rel="noopener">WebAssembly spec</a>:</p>
<blockquote>
<p>WebAssembly (abbreviated wasm) is a safe, portable, low-level code format designed for efficient execution and compact representation.</p>
</blockquote>
<p>WebAssembly is the first new runnable format supported by all major browsers. It is also showing promise as a standardized way to deploy code to edge environments.</p>
<p>Rust is a popular language for writing code compiled to WebAssembly. This is not just because of Rust&#39;s minimal runtime needs, but also because of its community and <a href="https://jldec.me/forays-from-node-to-rust#first-impressions" target="_blank" rel="noopener">tools</a>.</p>
<h2 id="cloudflare-workers">Cloudflare Workers</h2>
<p><a href="https://workers.cloudflare.com/" target="_blank" rel="noopener">Cloudflare Workers</a> offers a low-cost, low-latency, serverless platform, making it an ideal complement for statically generated websites. Cloudflare Workers use <a href="https://github.com/v8/v8#readme" target="_blank" rel="noopener">V8</a>, the same open source JavaScript engine from Google which is used in <a href="https://nodejs.org/en/about/" target="_blank" rel="noopener">Node.js</a> and <a href="https://deno.land/" target="_blank" rel="noopener">Deno</a>.</p>
<p>The <a href="https://developers.cloudflare.com/workers/runtime-apis" target="_blank" rel="noopener">APIs</a> available to Cloudflare Workers are very limited - Unlike Node, there is no module loader and no access to the host platform.</p>
<blockquote>
<p>Workers handle requests from the Web,<br>and they can call other Web services.</p>
</blockquote>
<p>While the default JavaScript is already quite efficient, workers can also run WebAssembly.</p>
<h2 id="creating-the-worker">Creating the worker</h2>
<p>This article demonstrates how to build a worker which calls a wasm <a href="https://github.com/jldec/shortscale-rs" target="_blank" rel="noopener">function</a> written in Rust.</p>
<p>The Cloudflare UI makes it easy to create new workers, but adding WebAssembly requires <a href="https://api.cloudflare.com/#worker-script-upload-worker" target="_blank" rel="noopener">API calls</a> with wasm <a href="https://developers.cloudflare.com/workers/platform/scripts#resource-bindings" target="_blank" rel="noopener">Resource Bindings</a>. Since this part of the API is not well documented, using the <strong>wrangler</strong> CLI is easier.</p>
<p><a href="https://developers.cloudflare.com/workers/cli-wrangler/install-update" target="_blank" rel="noopener">Install wrangler</a> and authenticate with <code>wrangler login</code>. Then run the following:</p>
<pre><code class="language-sh">$ wrangler generate wasm-worker -t rust
</code></pre>
<pre><code>üîß   Creating project called `wasm-worker`...
‚ú®   Done! New project created ./wasm-worker
üïµÔ∏è  You will need to update the following fields in the created wrangler.toml file before continuing:
üïµÔ∏è  You can find your account_id in the right sidebar of your account&#39;s Workers page, and zone_id in the right sidebar of a zone&#39;s overview tab at https://dash.cloudflare.com
- account_id
</code></pre>
<p>This creates a directory called <code>wasm-worker</code> populated with files from <a href="https://github.com/cloudflare/rustwasm-worker-template/tree/72d390bf22983d43a1da3681faa093874fa32837" target="_blank" rel="noopener">github.com/cloudflare/rustwasm-worker-template</a>.</p>
<h2 id="wrangler-dev">wrangler dev</h2>
<p>You can now call <code>wrangler dev</code> to build and run the worker.</p>
<p><em>Note</em>: There is no need to run &#39;wasm-pack&#39; as suggested by the project README, and as of wrangler <a href="https://github.com/cloudflare/wrangler/releases/tag/v1.18.0" target="_blank" rel="noopener">v1.18.0</a>, your &#39;account _id&#39; will be auto-inferred by wrangler, if omitted from wrangler.toml.</p>
<pre><code>$ wrangler dev
üåÄ  Compiling your project to WebAssembly...
[INFO]: üéØ  Checking for the Wasm target...
[INFO]: üåÄ  Compiling to Wasm...
...
   Compiling wasm-worker v0.1.0
    Finished release [optimized] target(s) in 12.43s
[INFO]: ‚¨áÔ∏è  Installing wasm-bindgen...
[INFO]: Optimizing wasm binaries with `wasm-opt`...
[INFO]: Optional fields missing from Cargo.toml: &#39;description&#39;, &#39;repository&#39;, and &#39;license&#39;. These are not necessary, but recommended
[INFO]: ‚ú®   Done in 13.03s
[INFO]: üì¶   Your wasm pkg is ready to publish at wasm-worker/pkg.
üíÅ  watching &quot;./&quot;
üëÇ  Listening on http://127.0.0.1:8787
</code></pre>
<p>Now browse to <a href="http://127.0.0.1:8787" target="_blank" rel="noopener">http://127.0.0.1:8787</a></p>
<p><img src="./images/hello-wasm-worker.png" alt="&#39;Hello wasm-worker!&#39; appears in the browser"></p>
<h2 id="modifications">Modifications</h2>
<p>For learning purposes, I pared the code down and pushed it to <a href="https://github.com/jldec/wasm-worker" target="_blank" rel="noopener">jldec/wasm-worker</a>.</p>
<ul>
<li>Removed unused files: <code>.appveyor.yml</code>, <code>.travis.yml</code>, <code>.cargo-ok</code></li>
<li>Removed <code>worker/metadata_wasm.json</code> - no longer used by wrangler</li>
<li>Removed optional libraries <code>console_error_panic_hook</code>, <code>wee_alloc</code>, and <code>cfg-if</code></li>
<li>Updated version of <code>wasm-bindgen</code></li>
<li>Filled in <code>description</code>, <code>license</code>, and <code>repository</code> in <code>Cargo.toml</code></li>
<li>Added <code>Cargo.lock</code> to <code>.gitignore</code></li>
<li>Rewrote the README</li>
</ul>
<p>I added the <a href="https://crates.io/crates/shortscale" target="_blank" rel="noopener">shortscale</a> crate, and changed <code>src/lib.rs</code>.</p>
<pre><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">shortscale<span class="token punctuation">::</span></span>shortscale<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[wasm_bindgen]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">numwords</span><span class="token punctuation">(</span>num<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">shortscale</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This is called from the <code>worker.js</code>.</p>
<pre><code class="language-js"><span class="token comment">// Return JSON using query param n.</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleRequest</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// pick up #[wasm_bindgen] exports from ../src/lib.rs</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> numwords <span class="token punctuation">}</span> <span class="token operator">=</span> wasm_bindgen<span class="token punctuation">;</span>

  <span class="token comment">// `wasm` binding name is auto-generated by wrangler</span>
  <span class="token keyword">await</span> <span class="token function">wasm_bindgen</span><span class="token punctuation">(</span>wasm<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> hello <span class="token operator">=</span> <span class="token string">'from wasm-worker'</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> n <span class="token operator">=</span> url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> words<span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    words <span class="token operator">=</span> <span class="token function">numwords</span><span class="token punctuation">(</span><span class="token function">BigInt</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    words <span class="token operator">=</span> <span class="token string">'undefined'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> hello<span class="token punctuation">,</span> n<span class="token punctuation">,</span> words <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json; charset=utf-8"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="wrangler-publish">wrangler publish</h2>
<p>Finally, I added a route and zone ID to my wrangler.toml and called <code>wrangler publish</code></p>
<pre><code>$ wrangler publish
üåÄ  Compiling your project to WebAssembly...
[INFO]: üéØ  Checking for the Wasm target...
[INFO]: üåÄ  Compiling to Wasm...
    Finished release [optimized] target(s) in 0.03s
[INFO]: ‚¨áÔ∏è  Installing wasm-bindgen...
[INFO]: Optimizing wasm binaries with `wasm-opt`...
[INFO]: ‚ú®   Done in 0.47s
[INFO]: üì¶   Your wasm pkg is ready to publish at wasm-worker/pkg.
‚ú®  Build succeeded
‚ú®  Successfully published your script to
 jldec.net/wasm-worker* =&gt; stayed the same
 https://wasm-worker.jldec.workers.dev
</code></pre>
<p>You can run the result at <a href="https://jldec.net/wasm-worker?n=123456789012345678" target="_blank" rel="noopener">https://jldec.net/wasm-worker?n=123456789012345678</a> - Round-trip response times in my area average under 30ms.</p>
<p><img src="./images/worker-request.png" alt="hello	&quot;from wasm-worker&quot; n &quot;123456789012345678&quot; words	&quot;one hundred and twenty three quadrillion four hundred and fifty six trillion seven hundred and eighty nine billion twelve million three hundred and forty five thousand six hundred and seventy eight&quot;"></p>
<h2 id="ü¶Ä-keep-ü¶Ä-digging-ü¶Ä">ü¶Ä Keep ü¶Ä Digging ü¶Ä</h2>
<p><em>To leave a comment<br>please visit <a href="https://dev.to/jldec/calling-rust-from-a-cloudflare-worker-17b4" target="_blank" rel="noopener">dev.to/jldec</a></em></p>
</div>
</div>


</div><!--page-->

<div id="credit"><p><span class="fa">&#xf004;</span> powered by <a href="https://jldec.github.io/pub-doc/" target="_blank" rel="noopener">pub-server</a> and <a href="https://github.com/jldec/pub-theme-pubblog" target="_blank" rel="noopener">pub-theme-pubblog</a></p>
</div>

</div>
</div>

</div><!--layout-->

<script>window.pubRef = {"href":"/calling-rust-from-a-cloudflare-worker","relPath":"."};</script>
<script src="./js/jquery-1.12.4.min.js" ></script>
<script src="./pub/pub-ux.js" ></script>
<!-- copyright -->
</body>
</html>

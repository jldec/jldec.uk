<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="robots" content="noindex, nofollow">
<link rel="canonical" href="https://jldec.me/running-a-compiled-deno-script-in-a-github-action">

<!-- html generated by pub-server from markdown /running-a-compiled-deno-script-in-a-github-action.md -->

<title>Running a compiled Deno script in a GitHub Action</title>
<link rel="stylesheet" href="./css/pubblog.css">
<link rel="stylesheet" href="./css/open-sans.css">
<link rel="stylesheet" href="./css/font-awesome.css">
<link rel="stylesheet" href="./css/highlight-9.18.1-github.css">
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>

<div data-render-layout="main-layout">
<header>
<div id="doctitle"><h1 id="jldecuk"><a href="./">jldec.uk</a></h1>
</div>
<div id="topmenu"><div data-render-html="/#topmenu">&nbsp;</div></div>
</header>

<div id="navicon" onclick=""><p><span class="fa fa-fw fa-2x">&#xf01a;</span></p>

<nav id="toc">
<ul>
<li><strong><a href="./">Home</a></strong></li>
<li><a href="./running-a-compiled-deno-script-in-a-github-action">Running a compiled Deno script in a GitHub Action</a></li>
<li><a href="./getting-started-with-deno">Getting Started with Deno</a></li>
<li><a href="./calling-rust-from-a-cloudflare-worker">Calling Rust from a Cloudflare Worker</a></li>
<li><a href="./fun-with-vercel">Fun with Vercel</a></li>
<li><a href="./first-steps-using-cloudflare-pages">First steps using Cloudflare Pages</a></li>
<li><a href="./migrating-from-cjs-to-esm">Migrating from CommonJS to ESM</a></li>
<li><a href="./forays-from-node-to-rust">Forays from Node to Rust</a></li>
<li><a href="./github-actions-101">GitHub Actions 101</a></li>
<li><a href="./a-web-for-everyone">A Web for Everyone</a></li>
<li><a href="./why-serverless-at-the-edge">Why Serverless at the Edge?</a></li>
<li><a href="./spring-boot-101">Spring Boot 101</a></li>
<li><a href="./why-the-web-needs-better-html-editing-components">Why the Web needs better HTML editing components</a></li>
<li><a href="./about">About me</a></li>
</ul>
</nav>
</div>

<div id="title" style='background-image:url("images/first-blossoms-2021.jpg");'>
  <div class="title">Running a compiled Deno script in a GitHub Action</div>
  <div class="subtitle"></div>
</div>

<div id="main" onclick="">
<div id="content">

<div data-render-page="/running-a-compiled-deno-script-in-a-github-action">
<span class="permalink"><a class="permalink" href="./running-a-compiled-deno-script-in-a-github-action" title="Link to this post.">&#xf0c1;</a></span><span class="date">2021-03-14</span>

<div >
<div data-render-html="/running-a-compiled-deno-script-in-a-github-action"><h2 id="tldr">TL;DR</h2>
<p>This is a quick followup to my recent post about <a href="./getting-started-with-deno">Getting Started with Deno</a>.</p>
<p>In this post I will enhance a GitHub Action to do the following:</p>
<ul>
<li>Generate HTML using a static site generator (SSG).</li>
<li>Launch a preview web server which runs in the background.</li>
<li>Download a compiled Deno script.</li>
<li>Invoke the Deno script to scan for broken links in the generated HTML.</li>
<li>Only publish the HTML if there are no broken links.</li>
</ul>
<h2 id="scanjs">scan.js</h2>
<p>I cross-compiled <a href="https://github.com/jldec/deno-hello/blob/main/scan.js" target="_blank" rel="noopener">scan.js</a> using Deno v1.8.1, and uploaded the resulting binaries to a <a href="https://github.com/jldec/deno-hello/releases" target="_blank" rel="noopener">release</a> on GitHub.</p>
<p>Using the releases feature of GitHub is a convenient way to publish compiled artifacts. In this case I used the manual upload feature in GitHub, but this step could be automated as well.</p>
<p><img src="./images/deno-scan-releases.png" alt="Releases with compiled artifacts in Repo deno-hello"></p>
<p>Here is the deno compile <a href="https://github.com/jldec/deno-hello/blob/main/compile.sh#L1" target="_blank" rel="noopener">command</a>. The binary for Linux is called <code>scan-linux-x86</code>.</p>
<pre><code>deno --unstable compile \
  --allow-net \
  --lite \
  --target x86_64-unknown-linux-gnu \
  --output scan-linux-x86 \
  scan.js
</code></pre>
<p>The resulting binaries are quite large (~50MB), even using <a href="https://deno.land/manual@v1.7.4/tools/compiler#generating-smaller-binaries" target="_blank" rel="noopener">--lite</a>, but I expect that to improve.</p>
<h2 id="githubworkflowgenerateyaml">.github/workflow/generate.yaml</h2>
<p>In this case, I modified the <a href="https://github.com/jldec/cloudflare-pages-test/blob/main/.github/workflows/generate.yaml" target="_blank" rel="noopener">workflow</a> for the static site in <a href="https://github.com/jldec/cloudflare-pages-test" target="_blank" rel="noopener">jldec/cloudflare-pages-test</a>. Here is the excerpt of the yaml for the relevant step.</p>
<pre><code class="language-yaml">- name: generate output
  run: |
    ...
    npm run generate
    npm run preview &amp;
    curl -LO https://github.com/jldec/deno-hello/releases/download/v1.0.0/scan-linux-x86 &amp;&amp; chmod +x scan-linux-x86
    ./scan-linux-x86 http://localhost:3001/
    ...
</code></pre>
<p><code>npm run generate</code> invokes the static site generator.  </p>
<p><code>npm run preview &amp;</code> starts the preview server on port 3001, running in the background.</p>
<p>Both commands are defined as scripts in <a href="https://github.com/jldec/cloudflare-pages-test/blob/main/package.json" target="_blank" rel="noopener">package.json</a>.</p>
<p><code>curl -LO</code> downloads the Linux binary from the GitHub release described earlier.</p>
<h2 id="success">Success</h2>
<p>When the <code>scan-linux-x86</code> command finds no broken links in the static site, it exits with 0, allowing the GitHub Action <a href="https://github.com/jldec/cloudflare-pages-test/runs/2107446999?check_suite_focus=true#step:4:59" target="_blank" rel="noopener">workflow</a> to continue.</p>
<p><img src="./images/scan-success.png" alt="scan success in GitHub Action log output"></p>
<p>If there are broken links the workflow will <a href="https://github.com/jldec/cloudflare-pages-test/runs/2107446999?check_suite_focus=true#step:4:59" target="_blank" rel="noopener">fail</a>, and I will hear about it in my inbox :)</p>
<p><img src="./images/scan-failure.png" alt="scan failure in GitHub Action log output"></p>
<blockquote>
<p><a href="https://deno.land/" target="_blank" rel="noopener"><img src="./images/deno-logo.png" class="no-border" alt="Deno logo"></a></p>
</blockquote>
<p><em>To leave a comment<br>please visit <a href="https://dev.to/jldec/getting-started-with-deno-2ie7" target="_blank" rel="noopener">dev.to/jldec</a></em></p>
</div>
</div>


</div><!--page-->

<div id="credit"><p><span class="fa">&#xf004;</span> powered by <a href="https://jldec.github.io/pub-doc/" target="_blank" rel="noopener">pub-server</a> and <a href="https://github.com/jldec/pub-theme-pubblog" target="_blank" rel="noopener">pub-theme-pubblog</a></p>
</div>

</div>
</div>

</div><!--layout-->

<script>window.pubRef = {"href":"/running-a-compiled-deno-script-in-a-github-action","relPath":"."};</script>
<script src="./js/jquery-1.12.4.min.js" ></script>
<script src="./js/highlight-9.18.1.min.js" ></script>
<script src="./js/pub-pkg-highlight.js" ></script>
<script src="./pub/pub-ux.js" ></script>
<!-- copyright -->
</body>
</html>

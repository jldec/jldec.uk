<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">

<meta property="og:title" content="Getting started with Python Packaging">
<meta property="og:image" content="https://jldec.me/images/rockford-office.jpg">
<meta property="og:type" content="article">
<meta property="og:url" content="https://jldec.me/getting-started-with-python">
<meta property="og:description" content="From zero to publishing a Python module on pypi.org.">
<meta name="twitter:site" content="@jldec">
<meta name="twitter:creator" content="@jldec">
<meta name="twitter:title" content="Getting started with Python Packaging">
<meta name="twitter:description" content="From zero to publishing a Python module on pypi.org.">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:widgets:new-embed-design" content="on">
<meta name="twitter:image" content="https://jldec.me/images/rockford-office.jpg">
<meta name="twitter:image:alt" content="View from Rockford Manor Dublin">
<meta name="robots" content="noindex, nofollow">
<link rel="canonical" href="https://jldec.me/getting-started-with-python-packaging">

<!-- html generated by pub-server from markdown /getting-started-with-python-packaging.md -->

<title>Getting started with Python Packaging</title>
<link rel="stylesheet" href="./css/pubblog.css">
<link rel="stylesheet" href="./css/open-sans.css">
<link rel="stylesheet" href="./css/font-awesome.css">
<link rel="stylesheet" href="./css/prism.css">
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>

<div data-render-layout="main-layout">
<header>
<div id="doctitle"><h1 id="jldecuk"><a href="./">jldec.uk</a></h1>
</div>
<div id="topmenu"><div data-render-html="/#topmenu">&nbsp;</div></div>
</header>

<div id="navicon" onclick=""><p><span class="fa fa-fw fa-2x">&#xf01a;</span></p>

<nav id="toc">
<ul>
<li><strong><a href="./">Home</a></strong></li>
<li><a href="./getting-started-with-python-packaging">Getting started with Python Packaging</a></li>
<li><a href="./lets-figure-out-whats-next-together">News</a></li>
<li><a href="./about">About me</a></li>
<li><a href="./what-is-git-lfs">What is git LFS?</a></li>
<li><a href="./first-impressions-of-the-new-github-projects-beta">First impressions of the new GitHub Projects Beta</a></li>
<li><a href="./using-gitpod-to-create-a-pr">Using Gitpod to create a PR</a></li>
<li><a href="./preventing-concurrent-github-actions">Preventing concurrent GitHub Actions</a></li>
<li><a href="./getting-started-with-go-part-3-goroutines-and-channels">Getting started with Goroutines and channels</a></li>
<li><a href="./getting-started-with-go-part-2-pointers">Getting started with Go pointers</a></li>
<li><a href="./getting-started-with-go">Getting started with Go</a></li>
<li><a href="./extracting-an-esm-module-from-a-deno-script">Extracting an ESM module from a Deno script</a></li>
<li><a href="./running-a-compiled-deno-script-in-a-github-action">Running a compiled Deno script in a GitHub Action</a></li>
<li><a href="./getting-started-with-deno">Getting Started with Deno</a></li>
<li><a href="./calling-rust-from-a-cloudflare-worker">Calling Rust from a Cloudflare Worker</a></li>
<li><a href="./fun-with-vercel">Fun with Vercel</a></li>
<li><a href="./first-steps-using-cloudflare-pages">First steps using Cloudflare Pages</a></li>
<li><a href="./migrating-from-cjs-to-esm">Migrating from CommonJS to ESM</a></li>
<li><a href="./forays-from-node-to-rust">Forays from Node to Rust</a></li>
<li><a href="./github-actions-101">GitHub Actions 101</a></li>
<li><a href="./a-web-for-everyone">A Web for Everyone</a></li>
<li><a href="./why-serverless-at-the-edge">Why Serverless at the Edge?</a></li>
<li><a href="./spring-boot-101">Spring Boot 101</a></li>
<li><a href="./why-the-web-needs-better-html-editing-components">Why the Web needs better HTML editing components</a></li>
</ul>
</nav>
</div>

<div id="title" style='background-image:url("./images/rockford-office.jpg");'>
  <div class="title">Getting started with Python Packaging</div>
  <div class="subtitle"></div>
</div>

<div id="main" onclick="">
<div id="content">

<div data-render-page="/getting-started-with-python-packaging">
<span class="permalink"><a class="permalink" href="./getting-started-with-python-packaging" title="Link to this post.">&#xf0c1;</a></span><span class="date">2023-02-22</span>

<div >
<div data-render-html="/getting-started-with-python-packaging"><h2 id="lets-do-some-python">Let&#39;s do some Python</h2>
<p>In preparation for using a lot more Python, I decided to refresh my Python knowedge and publish my first Python module at <a href="https://pypi.org/project/shortscale/" target="_blank" rel="noopener">https://pypi.org/project/shortscale/</a>.</p>
<p>Some readers may recognize <a href="https://jldec.me/forays-from-node-to-rust" target="_blank" rel="noopener">shortscale</a> from earlier explorations in <a href="https://github.com/jldec/shortscale" target="_blank" rel="noopener">JavaScript</a>, <a href="https://github.com/jldec/shortscale-rs" target="_blank" rel="noopener">Rust</a>, and <a href="https://github.com/jldec/shortscale-go" target="_blank" rel="noopener">Go</a>.</p>
<p>This post covers the following steps:</p>
<ol>
<li>Install Python on macOS</li>
<li>Write the skeleton code, with just a one-line function.</li>
<li>Build and publish the incomplete <a href="https://github.com/jldec/shortscale-py/tree/bb9b026b9097ce9c601e632a9d1f74a7da6adf29" target="_blank" rel="noopener">v0.1</a> module.</li>
<li>Complete the logic <a href="https://github.com/jldec/shortscale-py/commit/6ab4a4b541590a60ebe2944473094465ba8f14f5" target="_blank" rel="noopener">v1.0.0</a>.</li>
<li>Benchmarks</li>
</ol>
<h2 id="install-python-v310-the-hard-way">Install python v3.10 (the hard way)</h2>
<p>Installing Python on macOS is easiest with <a href="https://www.python.org/downloads/macos/" target="_blank" rel="noopener">the official installer</a> or <a href="https://realPython.com/installing-python/#how-to-install-from-homebrew" target="_blank" rel="noopener">with homebrew</a>. </p>
<p>I wanted a way to switch between Python versions, so I followed the instructions for <a href="https://github.com/pyenv/pyenv" target="_blank" rel="noopener">pyenv</a>. </p>
<p>NOTE: This does a full local build of CPython, and requires dependencies different from the macOS command line tools.</p>
<pre><code># 1. Install pyenv 
# from https://github.com/pyenv/pyenv#set-up-your-shell-environment-for-pyenv
git clone https://github.com/pyenv/pyenv.git $HOME/.pyenv
export PYENV_ROOT=&quot;$HOME/.pyenv&quot;
export PATH=&quot;$PYENV_ROOT/bin:$PATH&quot;
eval &quot;$(pyenv init --path)&quot;

# 2. Fix dependencies for macOS 
# from https://github.com/pyenv/pyenv/wiki#suggested-build-environment
brew install openssl readline sqlite3 xz zlib tcl-tk

# 3. After the brew install, fix LDFLAGS, CPPFLAGS and add tcl-tk/bin onto PATH 
export LDFLAGS=&quot;$LDFLAGS -L$HOME/homebrew/opt/openssl@3/lib -L$HOME/homebrew/opt/readline/lib -L$HOME/homebrew/opt/sqlite/lib -L$HOME/homebrew/opt/zlib/lib -L$HOME/homebrew/opt/tcl-tk/lib -L$HOME/homebrew/opt/openssl@3/lib -L$HOME/homebrew/opt/readline/lib -L$HOME/homebrew/opt/sqlite/lib -L$HOME/homebrew/opt/zlib/lib -L$HOME/homebrew/opt/tcl-tk/lib&quot;
export CPPFLAGS=&quot;$CPPFLAGS -I$HOME/homebrew/opt/openssl@3/include -I$HOME/homebrew/opt/readline/include -I$HOME/homebrew/opt/sqlite/include -I$HOME/homebrew/opt/zlib/include -I$HOME/homebrew/opt/tcl-tk/include -I$HOME/homebrew/opt/openssl@3/include -I$HOME/homebrew/opt/readline/include -I$HOME/homebrew/opt/sqlite/include -I$HOME/homebrew/opt/zlib/include -I$HOME/homebrew/opt/tcl-tk/include&quot;
export PATH=$HOME/homebrew/opt/tcl-tk/bin:$PATH

# 4. Use pyenv to build and install python v3.10 and make it the global default
pyenv install 3.10
pyenv global 3.10

# Point to the installed version in  .bash_profile (instead of depending on the pyenv shim)
export PATH=$HOME/.pyenv/versions/3.10.9/bin:$PATH
</code></pre>
<h2 id="virtual-environments-and-pip">Virtual environments and pip</h2>
<p>Python <a href="https://docs.python.org/3/tutorial/modules.html" target="_blank" rel="noopener">modules</a> and their dependencies can be installed from <a href="https://pypi.org/" target="_blank" rel="noopener">pypi.org</a> using <code>pip install</code>.</p>
<p>Configuring a <a href="https://docs.python.org/3/library/venv.html" target="_blank" rel="noopener">virtual environment</a> will isolate modules under a <code>.venv</code> directory, which is easy to clean up, rather than installing everything globally.</p>
<p>I created a venv under my home directory using the following command</p>
<pre><code class="language-sh">python3 -m venv ~/.venv
</code></pre>
<p>Instead of &quot;activating&quot; the venv, which changes the prompt, I prefer to prepend it directly onto my PATH for now.</p>
<pre><code>export PATH=$HOME/.venv/bin:$PATH
export VIRTUAL_ENV=$HOME/.venv
</code></pre>
<h2 id="create-a-new-module-called-shortscale">Create a new module called shortscale</h2>
<p>First I wrote a skeleton <code>shortscale</code> function which just returns a string with the input.</p>
<p>The rest of the code is boilerplate, to make the function callable on the command line. Passing base=0 to <a href="https://docs.python.org/3/library/functions.html#int" target="_blank" rel="noopener">int()</a> enables numeric literal input with different bases. </p>
<h4 id="shortscalepy">shortscale.py</h4>
<pre><code class="language-py"><span class="token triple-quoted-string string">"""English conversion from number to string"""</span>
<span class="token keyword">import</span> sys

__version__ <span class="token operator">=</span> <span class="token string">"0.1.0"</span>

<span class="token keyword">def</span> <span class="token function">shortscale</span><span class="token punctuation">(</span>num<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>
  <span class="token keyword">return</span> <span class="token string">'{} ({} bits)'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span> num<span class="token punctuation">.</span>bit_length<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">'Usage: shortscale num'</span><span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

  <span class="token keyword">print</span><span class="token punctuation">(</span>shortscale<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
  main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>The output looks like this:</p>
<pre><code class="language-sh">$ python shortscale.py 0x42
66 (7 bits)
</code></pre>
<p>Next, I built and published this incomplete <a href="https://github.com/jldec/shortscale-py/tree/bb9b026b9097ce9c601e632a9d1f74a7da6adf29" target="_blank" rel="noopener">v0.1</a> shortscale module.</p>
<p>Unlike the npm JavaScript ecosystem, you can&#39;t just use pip to publish a module to the pypi repository. There are <a href="https://packaging.python.org/en/latest/tutorials/packaging-projects/#creating-pyproject-toml" target="_blank" rel="noopener">different build tools</a> to choose from.</p>
<p>I chose <code>setuptools</code> because it appears to be the closest to a standard, and shows what it&#39;s doing. This meant installing <a href="https://pypi.org/project/build/" target="_blank" rel="noopener">build</a> and <a href="https://pypi.org/project/build/" target="_blank" rel="noopener">twine</a>.   </p>
<p>Python packages are described in a <code>pyproject.toml</code>. Note that project.scripts points to the CLI entrypoint at main().</p>
<h4 id="pyprojecttoml">pyproject.toml</h4>
<pre><code class="language-toml">[project]
name = &quot;shortscale&quot;
description = &quot;English conversion from number to string&quot;
authors = [{name = &quot;Jürgen Leschner&quot;, email = &quot;jldec@users.noreply.github.com&quot;}]
readme = &quot;README.md&quot;
license = {file = &quot;LICENSE&quot;}
classifiers = [&quot;License :: OSI Approved :: MIT License&quot;]
dynamic = [&quot;version&quot;]

[project.urls]
Home = &quot;https://github.com/jldec/shortscale-py&quot;

[project.scripts]
shortscale = &quot;shortscale:main&quot;

[build-system]
requires = [&quot;setuptools&gt;=61.0&quot;]
build-backend = &quot;setuptools.build_meta&quot;

[tool.setuptools.dynamic]
version = {attr = &quot;shortscale.__version__&quot;}
</code></pre>
<h3 id="build-the-module">Build the module</h3>
<p>The build tool creates 2 module bundles (source and runnable code) in the ./dist directory.</p>
<pre><code>$ python -m build
...
discovered py_modules -- [&#39;shortscale&#39;]
...
creating &#39;/Users/jldec/pub/shortscale-py/dist/.tmp-d0g4dwyd/shortscale-0.1.0-py3-none-any.whl&#39; and adding &#39;build/bdist.macosx-13.1-arm64/wheel&#39; to it
adding &#39;shortscale.py&#39;
adding &#39;shortscale-0.1.0.dist-info/LICENSE&#39;
adding &#39;shortscale-0.1.0.dist-info/METADATA&#39;
adding &#39;shortscale-0.1.0.dist-info/WHEEL&#39;
adding &#39;shortscale-0.1.0.dist-info/entry_points.txt&#39;
adding &#39;shortscale-0.1.0.dist-info/top_level.txt&#39;
adding &#39;shortscale-0.1.0.dist-info/RECORD&#39;
removing build/bdist.macosx-13.1-arm64/wheel
Successfully built shortscale-0.1.0.tar.gz and shortscale-0.1.0-py3-none-any.whl
</code></pre>
<h3 id="publish-to-pypiorg">Publish to pypi.org</h3>
<pre><code>$ python -m twine upload dist/*
Uploading distributions to https://upload.pypi.org/legacy/
Uploading shortscale-0.1.0-py3-none-any.whl
Uploading shortscale-0.1.0.tar.gz
...
View at:
https://pypi.org/project/shortscale/0.1.0/
</code></pre>
<h2 id="install-and-run-in-a-venv">Install and run in a venv</h2>
<p>The moment of truth. Install the module in a new venv, and invoke it.</p>
<pre><code class="language-sh">$ mkdir test
$ cd test
$ python -m venv .venv
$ source .venv/bin/activate

(.venv) $ pip install shortscale
Collecting shortscale
  Using cached shortscale-0.1.0-py3-none-any.whl (3.8 kB)
Installing collected packages: shortscale
Successfully installed shortscale-0.1.0

(.venv) $ shortscale 0xffffffffffff
281474976710655 (48 bits)

$ deactivate
$ 
</code></pre>
<h2 id="complete-the-logic">Complete the logic</h2>
<p>Python still amazes me with its terseness and readability. </p>
<p>The code ended up needing <a href="https://github.com/jldec/shortscale-py/blob/main/shortscale.py" target="_blank" rel="noopener">3 functions</a>, of which the longest is 30 lines with generous spacing. </p>
<p>Here is the function which decomposes a number into powers of 1000. I wonder if this could be expressed as a <a href="https://docs.python.org/3/tutorial/datastructures.html#list-comprehensions" target="_blank" rel="noopener">list comprehension</a>?</p>
<pre><code class="language-py"><span class="token keyword">def</span> <span class="token function">powers_of_1000</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Return list of (n, exponent) for each power of 1000.
    List is ordered highest exponent first.
    n = 0 - 999.
    exponent = 0,1,2,3...
    """</span>
    p_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    exponent <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> n <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
        p_list<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>n <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">,</span> exponent<span class="token punctuation">)</span><span class="token punctuation">)</span>
        n <span class="token operator">=</span> n <span class="token operator">//</span> <span class="token number">1000</span>
        exponent <span class="token operator">+=</span> <span class="token number">1</span>

    <span class="token keyword">return</span> p_list
</code></pre>
<p>The <a href="https://github.com/jldec/shortscale-py/blob/main/tests/test_shortscale.py" target="_blank" rel="noopener">test function</a> took just 3 lines:</p>
<pre><code class="language-py"><span class="token keyword">def</span> <span class="token function">test_shortscale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>num<span class="token punctuation">,</span> s<span class="token punctuation">)</span> <span class="token keyword">in</span> TESTS<span class="token punctuation">:</span>
        <span class="token keyword">assert</span> shortscale<span class="token punctuation">.</span>shortscale<span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token operator">==</span> s
</code></pre>
<h2 id="benchmarks">Benchmarks</h2>
<p>I was pleased with the <a href="https://github.com/jldec/shortscale-py/blob/main/tests/bench_shortscale.py" target="_blank" rel="noopener">benchmarks</a> as well. For this string-manipulation test-case, Python is only 2-3x slower than JavaScript on V8.</p>
<p>Compiled languages like Go and Rust will outperform that, but again, not by a huge amount.   </p>
<p>The results below are from my personal M1 arm64 running macOS.</p>
<h4 id="python">Python</h4>
<pre><code>$ python tests/bench_shortscale.py 
         1 calls,        100 bytes,    11750 ns/call
         2 calls,        200 bytes,     5584 ns/call
         5 calls,        500 bytes,     4367 ns/call
        10 calls,       1000 bytes,     4158 ns/call
        20 calls,       2000 bytes,     4087 ns/call
        50 calls,       5000 bytes,     4043 ns/call
       100 calls,      10000 bytes,     4063 ns/call
       200 calls,      20000 bytes,     4055 ns/call
       500 calls,      50000 bytes,     3914 ns/call
      1000 calls,     100000 bytes,     3839 ns/call
      2000 calls,     200000 bytes,     3426 ns/call
      5000 calls,     500000 bytes,     3044 ns/call
     10000 calls,    1000000 bytes,     2479 ns/call
     20000 calls,    2000000 bytes,     2131 ns/call
     50000 calls,    5000000 bytes,     2067 ns/call
    100000 calls,   10000000 bytes,     2072 ns/call
</code></pre>
<h4 id="javascript">Javascript</h4>
<pre><code>&gt; node test/bench.js

20000 calls, 2000000 bytes, 1083 ns/call
20000 calls, 2000000 bytes, 863 ns/call
20000 calls, 2000000 bytes, 793 ns/call
20000 calls, 2000000 bytes, 809 ns/call
20000 calls, 2000000 bytes, 789 ns/call
20000 calls, 2000000 bytes, 809 ns/call
20000 calls, 2000000 bytes, 774 ns/call
20000 calls, 2000000 bytes, 782 ns/call
20000 calls, 2000000 bytes, 796 ns/call
20000 calls, 2000000 bytes, 792 ns/call
20000 calls, 2000000 bytes, 791 ns/call
20000 calls, 2000000 bytes, 803 ns/call
20000 calls, 2000000 bytes, 796 ns/call
20000 calls, 2000000 bytes, 790 ns/call
20000 calls, 2000000 bytes, 797 ns/call
</code></pre>
<h4 id="go">Go</h4>
<pre><code>$ go test -bench . -benchmem
goos: darwin
goarch: arm64
pkg: github.com/jldec/shortscale-go
BenchmarkShortscale-8   	 4227788	       252.0 ns/op	     248 B/op	       5 allocs/op
--- BENCH: BenchmarkShortscale-8
    shortscale_test.go:38: 1 iterations, 100 bytes
    shortscale_test.go:38: 100 iterations, 10000 bytes
    shortscale_test.go:38: 10000 iterations, 1000000 bytes
    shortscale_test.go:38: 1000000 iterations, 100000000 bytes
    shortscale_test.go:38: 4227788 iterations, 422778800 bytes
PASS
ok  	github.com/jldec/shortscale-go	1.629s
</code></pre>
<h4 id="rust">Rust</h4>
<pre><code>$ cargo bench

running 2 tests
test a_shortscale                        ... bench:         182 ns/iter (+/- 3)
test b_shortscale_string_writer_no_alloc ... bench:          63 ns/iter (+/- 2)

test result: ok. 0 passed; 0 failed; 0 ignored; 2 measured
</code></pre>
<p>For a small optimization, check out this <a href="https://github.com/jldec/shortscale-py/pull/1/files" target="_blank" rel="noopener">PR</a>.</p>
<blockquote>
<blockquote>
<p>Keep on learning<br>🚀</p>
</blockquote>
</blockquote>
</div>
</div>


</div><!--page-->

<div id="credit"><p><span class="fa">&#xf004;</span> powered by <a href="https://jldec.github.io/pub-doc/" target="_blank" rel="noopener">pub-server</a> and <a href="https://github.com/jldec/pub-theme-pubblog" target="_blank" rel="noopener">pub-theme-pubblog</a></p>
</div>

</div>
</div>

</div><!--layout-->

<script>window.pubRef = {"href":"/getting-started-with-python-packaging","relPath":"."};</script>
<script src="./js/jquery-1.12.4.min.js" ></script>
<script src="./pub/pub-ux.js" ></script>
<!-- copyright -->
</body>
</html>
